<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Security Baseline for AWS Subaccounts | Majin Buu on Security</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Security Baseline for AWS Subaccounts" />
<meta name="author" content="Majin Buu" />
<meta property="og:locale" content="en" />
<meta name="description" content="I wanted to create some basic open-source code to create new AWS accounts and Terraform them. Every company seems to re-implement this privately, this can serve as a starting point for them." />
<meta property="og:description" content="I wanted to create some basic open-source code to create new AWS accounts and Terraform them. Every company seems to re-implement this privately, this can serve as a starting point for them." />
<link rel="canonical" href="http://localhost:4000/2024/01/19/aws-subaccount-baseline.html" />
<meta property="og:url" content="http://localhost:4000/2024/01/19/aws-subaccount-baseline.html" />
<meta property="og:site_name" content="Majin Buu on Security" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-19T00:00:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Security Baseline for AWS Subaccounts" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Majin Buu"},"dateModified":"2024-01-19T00:00:00-08:00","datePublished":"2024-01-19T00:00:00-08:00","description":"I wanted to create some basic open-source code to create new AWS accounts and Terraform them. Every company seems to re-implement this privately, this can serve as a starting point for them.","headline":"Security Baseline for AWS Subaccounts","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/01/19/aws-subaccount-baseline.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/logo.jpeg"},"name":"Majin Buu"},"url":"http://localhost:4000/2024/01/19/aws-subaccount-baseline.html"}</script>
<!-- End Jekyll SEO tag -->




<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open%20Sans|Roboto|Roboto%20Slab|Inconsolata|Dancing%20Script|Noto%20Sans%20SC|Noto%20Sans%20TC|Noto%20Serif%20SC|Noto%20Serif%20TC|Ma%20Shan%20Zheng">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/skin.css">

<script async src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>




  </head>

  <body>
    <div class="site-container">
      <header class="site-header">
        <div class="wrapper">
  <script>
    function clickSidebarButton() {
      const elem = document.getElementById("site-sidebar")
      if (elem.style.display == "none" || elem.style.display == "") {
        elem.style.display = "block";
      } else {
        elem.style.display = "none";
      }
    }
  </script>
  <a class="site-sidebar-button" onclick="clickSidebarButton()"><i class="far fa-user"></i>
  </a>

  <a class="site-title" rel="author" href="/">Majin Buu on Security</a>

  
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger" title="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <ul class="trigger">
              <li><a class="" href="/about/">About</a></li>
            
              <li><a class="" href="/posts/">Posts</a></li>
            </ul>
    </nav>
  
</div>

      </header>
      
      <div class="site-body wrapper">
        <aside class="site-sidebar" id="site-sidebar">
          
            <h3 class="toc-title">Table of Contents</h3>
<nav class="toc-nav">
  <ul class="toc">
  <li><a href="#summary">Summary</a>
    <ul>
      <li><a href="#how-it-works">How It Works</a></li>
    </ul>
  </li>
  <li><a href="#handling-all-those-services">Handling All Those Services</a>
    <ul>
      <li><a href="#implementing-the-allowlist">Implementing the Allowlist</a></li>
      <li><a href="#service-specific-mitigations">Service-Specific Mitigations</a></li>
    </ul>
  </li>
  <li><a href="#faq">FAQ</a>
    <ul>
      <li><a href="#what-does-this-not-solve">What does this not solve?</a></li>
      <li><a href="#what-about-buy-instead-of-build-here">What about Buy instead of Build here?</a></li>
      <li><a href="#how-do-i-translate-this-work-into-metrics-on-my-resume">How do I translate this work into metrics on my resume?</a></li>
    </ul>
  </li>
</ul>

</nav>

          
        </aside>
        <main class="site-main" id="site-main" aria-label="Content" tabindex="1">
          <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title p-name" itemprop="name headline">Security Baseline for AWS Subaccounts</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-01-19T00:00:00-08:00" itemprop="datePublished">
        Jan 19, 2024
      </time></p>

  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I wanted to create some basic open-source code to create new AWS accounts and Terraform them. Every company seems to re-implement this privately, this can serve as  a starting point for them.</p>

<!-- (It is also a prerequisite to other things I want to write about.) -->

<h2 id="summary">Summary</h2>

<h3 id="how-it-works">How It Works</h3>

<p>The steps are as follows:</p>

<ol>
  <li>Making the account</li>
  <li>Creating the SCP baseline</li>
  <li>Creating the account configuration baseline</li>
  <li>Modifying existing Terraform</li>
</ol>

<p>A lot of ink has been spilled on the 2nd Part, SCPs, but not how they fit into the bigger picture.</p>

<p>This is the foundation that lays the ground work for everything else. And the north star all legacy accounts and acquisitions get improved to match.</p>

<p>It is anologous to, in the AppSec realm, <a href="https://www.cookiecutter.io/templates">a cookie-cutter repository</a> enabling all the security bells-and-whistles to new microservices.</p>

<p>My initial goal is that companies can fork the repository to get started on their own custom baseline. A reference implementation.</p>

<p>Because all companies will have different OU structure, (think SCP inheritance), it is unlikely different companies will be able to use this same code.</p>

<!-- Perhaps one day the modules can be modular enough that different companies to use the same OSS code. -->
<!-- Hopefully other companies can contribute to it too. -->
<!-- n the UI/UX for customers or detailed to the extent I would like. -->
<!-- and What Does Good Look Like for your entire AWS footprint. -->

<!-- We will not cover e.g. east-west traffic. -->

<h2 id="handling-all-those-services">Handling All Those Services</h2>

<p>Since each AWS service has its own nuances and possible security problems. The primary way to mitigate this risk is to <a href="#implementing-the-allowlist">implement an allowlist</a> strategy for IAM services, which limits the amount of AWS services you need to know in-depth.</p>

<p>Once you have this allowlist, you can cross-refence each service with the <a href="#mitigations-per-service">Mitigations Per Service</a> section and ensure you have the proper mitigations in place.</p>

<h3 id="implementing-the-allowlist">Implementing the Allowlist</h3>

<p>When a customer requests an AWS account<sup id="fnref:1424" role="doc-noteref"><a href="#fn:1424" class="footnote" rel="footnote">1</a></sup>, the fill-out form should ask them a set of questions including, “Which AWS services and regions will you be using?”</p>

<p>This will end up translating to e.g. Terraform local variables</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">locals</span> <span class="p">{</span>
  <span class="n">services</span> <span class="o">=</span> <span class="p">[</span><span class="s">"dynamodb"</span><span class="p">,</span> <span class="s">"ec2"</span><span class="p">,</span> <span class="s">"s3"</span><span class="p">]</span>
  <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s">"us-east-2"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Which will further be passed into a configuration module, an SCP module, or both, for the subaccount.</p>

<h3 id="service-specific-mitigations">Service-Specific Mitigations</h3>

<p>Rather than simply giving the subaccount admin IAM role <code class="language-plaintext highlighter-rouge">"ec2:*"</code> and calling it a day, you should go further and ask service-specific questions.</p>

<ul>
  <li>“Do you need publicly accessible EC2 resources? If so, please explain why.”</li>
  <li>“Can you use our Terraform module for launching EC2? If not, please explain why.”</li>
</ul>

<p>Which can, depending on the answers, end up getting translated to e.g.</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">module</span> <span class="s">"project_x_account"</span> <span class="p">{</span>
  <span class="n">source</span> <span class="o">=</span> <span class="s">"../../modules/subaccounts/configuration"</span>

  <span class="n">services</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">services</span>
  <span class="n">regions</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">regions</span>

  <span class="n">imdsv1_disabled</span> <span class="o">=</span> <span class="no">false</span>  <span class="c">// AWSSEC-123 TODO: Remove this</span>
<span class="p">}</span>
</code></pre></div></div>
<p>If for some reason the customer needed IMDSv1 enabled in their account.</p>

<p>The <code class="language-plaintext highlighter-rouge">imdsv1_disabled</code> argument, will turn-off a mitigation that is on by default, such as an <a href="https://github.com/ScaleSec/terraform_aws_scp/blob/521ac29d712a6ebb51feb6f11b56e6c40b61bada/security_controls_scp/modules/ec2/require_imdsv2.tf#L5-L28">SCP enforcing IMDSv2</a> through the <code class="language-plaintext highlighter-rouge">"ec2:MetadataHttpTokens"</code> <a href="https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonec2.html#amazonec2-policy-keys">condition key</a>.</p>

<h2 id="faq">FAQ</h2>

<h3 id="what-does-this-not-solve">What does this not solve?</h3>

<ul>
  <li>AWS Account Inventory System with a good UI.</li>
</ul>

<p>Tags are not a great solution for storing metadata.</p>

<ul>
  <li>A Web UI for Creating the Account</li>
</ul>

<p>I could build a minimal Flask app to ask customers to fill out a form, and then call the AWS API myself to make the account.</p>

<p>The web app would need to be integrated with GitHub to make the PR, however.</p>

<h3 id="what-about-buy-instead-of-build-here">What about Buy instead of Build here?</h3>

<p>That is a rabbit hole of a subject. My bottom line up front (BLUF) is that this should satisfy your every need.</p>

<p>If it doesn’t I’d be interested to know why. I’ll (eventually, probably months later) update this post with your feedback.</p>

<p>Compared to <a href="https://docs.aws.amazon.com/controltower/latest/userguide/aft-architecture.html">Account Factory</a>, running a Python script is much more manual, a Flask app would improve the UI as I answer in the previous question.</p>

<p>However, AF is complicated AF, see the <a href="https://en.wikipedia.org/wiki/Rube_Goldberg_machine">Rude Goldberg machine</a> diagram:
<img src="https://i.imgur.com/J13xltK.png" alt="alt text" /></p>

<h3 id="how-do-i-translate-this-work-into-metrics-on-my-resume">How do I translate this work into metrics on my resume?</h3>

<p>For this part, “baseline” is an ever moving target. There is no industry standard baseline. Since this is OSS you can reference it, however.</p>

<p>Story time:
Ryan McHeegan wrote a blameless post-mortem of the Mudge disclosure <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>
Present to the Twitter board that 90% of Mac laptops now adhere to the baseline.
Where all it is is there is a program installed on 90% of laptops.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1424" role="doc-endnote">
      <p>For sandbox accounts, this may not be realistic, so you may need to manually maintain a deny list of dangerous services. Granted, you should be seamlessly re-creating sandbox accounts (or, less ideally, <a href="https://github.com/rebuy-de/aws-nuke">nuking</a>) regularly and only have public data in them. <a href="#fnref:1424" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Two people I have enormous amounts of respect for, goes without saying. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <footer class="post-footer">
    

    

    <nav class="post-pagination" role="navigation">
      
        <a class="post-previous" href="/2023/12/17/soft-tabletops.html">
          <h4 class="post-pagination-label">Prev</h4>
          <span class="post-pagination-title">
            <i class="fas fa-arrow-left"></i> [WIP] Softtop Scenarios

          </span>
        </a>
      

      
    </nav>
  </footer>

  
  
</article>

          <footer class="site-footer">
            <div class="footer-col-wrapper">

  <div class="footer-col">
    <div class="copyright">
      
      
      
      
      <p>Copyright © 2023&nbsp;-&nbsp;2024 Majin Buu; All rights reserved.</p>
      
    </div>
  </div>

  <div class="footer-col">
    <p>Let me know via email if you have any feedback on this site.</p>
  </div>
</div>

          </footer>        </main>
      </div>
    </div>
  </body>

</html>
